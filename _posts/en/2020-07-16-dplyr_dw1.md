---
layout: post
title: Data wrangling with dplyr in R
subtitle: dplyr's pivoting, select, filter, rename functions
categories: data
tags: [R, rstats, data wrangling, tidyverse, dplyr]
language: en
---

Data wrangling is the process of shaping data into a format that is appropriate for specific analytical purposes. In the following example we shall read John Hopkins University's (JHU) COVID-19 deaths database. It contains daily cumulative number of COVID-19 deaths for countries, and in some cases (like USA) for provinces/states. Our focus is on four Visegrad (V4) countries (i.e. Czechia, Hungary, Poland and Slovakia). Each V4 country represented by a single row in the database. 

Lets read the data with `read_csv` function that is part of `tidyverse` package. It will create a [`tibble`](https://tibble.tidyverse.org/), that is a "modern" form of `data.frame`.

```{r}
uri <- c("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv")
df <- read_csv(uri)
```

    # A tibble: 266 x 180
       `Province/State` `Country/Region`   Lat   Long `1/22/20` `1/23/20`  
       <chr>            <chr>            <dbl>  <dbl>     <dbl>     <dbl>  
     1 NA               Afghanistan       33.9  67.7          0         0  
     2 NA               Albania           41.2  20.2          0         0  
     3 NA               Algeria           28.0   1.66         0         0  
     4 NA               Andorra           42.5   1.52         0         0  
     5 NA               Angola           -11.2  17.9          0         0  
     6 NA               Antigua and Bar…  17.1 -61.8          0         0  
     7 NA               Argentina        -38.4 -63.6          0         0  
     8 NA               Armenia           40.1  45.0          0         0  
     9 Australian Capi… Australia        -35.5 149.           0         0  
    10 New South Wales  Australia        -33.9 151.           0         0  
 
As you can see Australia is represented by more than one `Province/State`, while some other (smaller) countries only one. So, in case of need one should aggregate data to country-level. We ,shall skip this step.
There are 266 rows (states) that is 188 unique countries (cf. `unique(df$'Country/Region')`. We also have 175 "day-date" columns, but we want to have only one for each values in long format.

![pivoting.png](/img/20-07-16-pivot/pivoting.png)

Before doing the actual pivoting we shall drop and rename some columns.

```{r}
df <- df %>% select(-c("Province/State", "Lat", "Long"))
df <- df %>% rename(c("country" = "Country/Region"))
```

Next we select V4 rows by filtering.

```{r}
v4 <- c("Hungary", "Slovakia", "Poland", "Czechia")
df <- df %>% filter(country %in% v4)
```
Now we can use [`pivot_longer`](https://tidyr.tidyverse.org/reference/pivot_longer.html) dplyr function to do the transformation. (A legacy function for the same is `gather`)

```{r}
# switch to long format, so each date column parsed to one column
df <- pivot_longer(df, cols = ends_with("20"),
    names_to = "date", values_to = "deaths")
```

Voila: 

    # A tibble: 704 x 3
       country date    deaths
       <chr>   <chr>    <dbl>
     1 Czechia 1/22/20      0
     2 Czechia 1/23/20      0

Notice that we used `cols=ends_with`, but there are several other ways to identify columns to be gathered. Other options for `tidy-select` argument are listed in [reference](https://tidyselect.r-lib.org/reference/language.html).  

We shall convert `date` column from character ``<chr>`` to date `<date>` format, and sort (aka [`arrange`](https://dplyr.tidyverse.org/reference/arrange.html) in tidyverse) rows by `date` and `country`.

```{r}
df$date <- as.Date(df$date, "%m/%d/%y")
df <- arrange(df, date, country)
tail(df)
```
    # A tibble: 6 x 3
      country  date       deaths
      <chr>    <date>      <dbl>
    1 Poland   2020-07-14   1588
    2 Slovakia 2020-07-14     28
    3 Czechia  2020-07-15    355
    4 Hungary  2020-07-15    595
    5 Poland   2020-07-15   1594
    6 Slovakia 2020-07-15     28

Now we can easily filter our columns based on date values like this: `df %>% filter(date >= "2020-06-14")`. And this long format is more usable with ggplot. 

However, it is simple to convert back our data to wide format with `pivot_wider` function:

```{r}
dfw <- df %>% pivot_wider(names_from = date, values_from = deaths)
```

Now we shall have 4 rows (V4 countries) and 176 columns (175 time-points). In wide format we can limit time-range with `select` function, which accept position intervals.   

```{r}
dfw <- dfw %>% select(1, 146:176)
```
That's all for now.

